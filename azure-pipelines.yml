name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yy)$(DayOfYear).$(BuildCounter)

parameters:
  - name: ContinueEvenIfResourcesAreGettingDestroyed
    displayName: "Continue even if resources are getting destroyed"
    type: boolean
    default: false
  - name: disableStryker
    displayName: "Disable Stryker"
    type: boolean
    default: false

trigger:
  - main
  - release/*
  - develop

pool: 
    name: NautilusBuild
    demands: vs_16 -equals 1 #exclude agents 13 and 14 as code coverage report fails

variables:
  - name: BuildConfiguration
    value: "release"
  - name: BuildPlatform
    value: "any cpu"
  - name: BuildCounter
    value: $[counter(format('{0:yyyyMMdd}', pipeline.startTime), 1)]
  - name: UKHOAssemblyCompany
    value: "UK Hydrographic Office"
  - name: UKHOAssemblyVersionPrefix
    value: "1.0."
  - name: UKHOAssemblyProduct
    value: "Periodic Output Service"
  - name: UKHOAssemblyCopyright
    value: "Copyright Â© UK Hydrographic Office"
  - name: DeploymentPool
    value: "UKHO Ubuntu 1804"
  - name: Container
    value: "ukhydrographicoffice/terraform-azure-powershell-unzip:1.1.9"
  - name: WindowPool
    value: "NautilusBuild"

stages:
  - stage: PERFORM_DEPENDENCYCHECK_DOTNETBUILD_DOTNETTEST_AND_PUBLISH
    displayName: "Build (inc DependencyChecker, Dotnet Build , dotnet test and publish artifact )"
    dependsOn: []
    jobs:
      - job: Stryker
        displayName: "Generate Stryker Report"
        condition: ${{ eq(parameters.disableStryker, false) }}
        variables:
          - name: StrykerDotNetVersion
            value: 8.0.x
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: sdk
              useGlobalJson: true
              workingDirectory: '$(Build.SourcesDirectory)'
  
          - task: UseDotNet@2
            displayName: 'Use .NET SDK for Stryker'
            inputs:
              packageType: sdk
              version: $(StrykerDotNetVersion)
  
          - task: PowerShell@1
            displayName: "Create global.json for .NET"
            inputs:
              scriptType: inlineScript
              workingFolder: $(Agent.TempDirectory)
              inlineScript: |
                dotnet new globaljson --sdk-version $(StrykerDotNetVersion)
  
          - task: DotNetCoreCLI@2
            displayName: "Install Stryker"
            inputs:
              command: custom
              custom: tool
              workingDirectory: $(Agent.TempDirectory)
              arguments: install dotnet-stryker --version 4.0.0 --tool-path $(Agent.BuildDirectory)/tools
  
          - task: Powershell@2
            displayName: "Run Stryker"
            inputs:
              workingDirectory: '$(Build.SourcesDirectory)\UKHO.PeriodicOutputService'
              targetType: 'inline'
              pwsh: true
              script: $(Agent.BuildDirectory)/tools/dotnet-stryker
  
          - task: PublishMutationReport@0
            displayName: 'Publish Stryker Mutator Report'
            inputs:
              reportPattern: '**/mutation-report.html'
              
      - job: Dependencychecker
        workspace:
          clean: all
        displayName: "Dependencychecker"
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: sdk
              useGlobalJson: true
              workingDirectory: '$(Build.SourcesDirectory)'

          - task: DotNetCoreCLI@2
            displayName: ".Net Core - NuGet restore non test projects only"
            inputs:
              command: "restore"
              projects: |
                **/*.csproj
                !**/*Tests.csproj
              feedsToUse: config
              noCache: true
              nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
              workingDirectory: '$(Build.SourcesDirectory)\UKHO.PeriodicOutputService'
              packagesDirectory: '$(Build.SourcesDirectory)\UKHO.PeriodicOutputService\packages'

          - task: CmdLine@1
            displayName: "Run OWASP Dependency Checker"
            inputs:
              filename: 'dependency-check.bat'
              arguments: '--project "periodic-output-service - $(Build.SourceBranchName)" --scan "$(Build.SourcesDirectory)\UKHO.PeriodicOutputService" --out "$(Build.ArtifactStagingDirectory)\DCReport" --suppression $(Build.SourcesDirectory)\NVDSuppressions.xml --noupdate'

          - task: PublishBuildArtifacts@1
            displayName: "Publish Artifact: OWASP Dependency Checker Report"
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)\DCReport'
              ArtifactName: "OWASP Dependency Checker Report"

          - task: PowerShell@1
            displayName: "Fail Build if Dependency Check Finds Any Vulnerabilities"
            inputs:
              scriptType: inlineScript
              arguments: '-ReportLocation $(Build.ArtifactStagingDirectory)\DCReport\*'
              inlineScript: |
                param($ReportLocation)
                Invoke-VulnerabilityCheck -ReportLocation $ReportLocation

      - job: UnitTestsAndCodeCoverage
        workspace:
          clean: all
        displayName: "Dotnet Test and Publish Code Coverage"
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: sdk
              useGlobalJson: true
              workingDirectory: '$(Build.SourcesDirectory)'

          - task: DotNetCoreCLI@2
            displayName: ".Net Core - NuGet restore test projects only"
            inputs:
              command: "restore"
              projects: "**/*Tests.csproj"
              feedsToUse: config
              noCache: true
              nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
              workingDirectory: '$(Build.SourcesDirectory)\UKHO.PeriodicOutputService'
              packagesDirectory: '$(Build.SourcesDirectory)\UKHO.PeriodicOutputService\packagesForTests'

          - task: DotNetCoreCLI@2
            displayName: "dotnet test - Perform Unit Tests"
            inputs:
              command: "test"
              projects: "**/*UnitTests.csproj"
              arguments: '--configuration $(BuildConfiguration) --settings "$(Build.SourcesDirectory)\test.runsettings" /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura'
              publishTestResults: true
              testRunTitle: "UnitTests"

          - task: PowerShell@2
            displayName: "Generate code coverage report"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)\CodeCoverageReport.ps1'
              arguments: '-source "$(Build.SourcesDirectory)" -reportFolder "$(Build.ArtifactStagingDirectory)"'

          - task: PublishBuildArtifacts@1
            displayName: "Publish Code coverage"
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)/codecoveragereport"
              ArtifactName: codecoveragereport

      - job: BuildAndPublishWebJob
        workspace:
          clean: all
        displayName: "Dotnet Build publish WebJob"
        steps:
          - task: PowerShell@2
            displayName: "Set assembly version numbers based on build ID"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)\Apply-AssemblyVersionAndDefaults.ps1'
              arguments: '-buildNumber "$(Build.BuildNumber)" -solutionDirectory "$(Build.SourcesDirectory)\UKHO.PeriodicOutputService\" -UKHOAssemblyCompany "$env:UKHOAssemblyCompany" -UKHOAssemblyCopyright "$(UKHOAssemblyCopyright)" -UKHOAssemblyVersionPrefix "$env:UKHOAssemblyVersionPrefix" -UKHOAssemblyProduct "$env:UKHOAssemblyProduct"'

          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: sdk
              useGlobalJson: true
              workingDirectory: '$(Build.SourcesDirectory)'

          - task: DotNetCoreCLI@2
            displayName: ".Net Core - NuGet restore"
            inputs:
              command: restore
              projects: |
                **/*.csproj
              feedsToUse: config
              noCache: true
              nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
              workingDirectory: '$(Build.SourcesDirectory)\UKHO.PeriodicOutputService'

          - task: DotNetCoreCLI@2
            displayName: "dotnet build task"
            inputs:
              command: "build"
              projects: "**/*.csproj"
              arguments: '--configuration $(BuildConfiguration) --output $(Build.BinariesDirectory)'

          - task: DotNetCoreCLI@2
            displayName: "Publish POS Fulfilment Service Code"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "**/*UKHO.PeriodicOutputService.Fulfilment.csproj"
              arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\PeriodicOutputFulfilmentService\App_Data\jobs\triggered\POSFulfilmentWebJob'
              zipAfterPublish: false
              modifyOutputPath: false

          - task: DotNetCoreCLI@2
            displayName: "Publish AIO Fulfilment Service Code"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "**/*UKHO.AdmiraltyInformationOverlay.Fulfilment.csproj"
              arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\PeriodicOutputFulfilmentService\App_Data\jobs\triggered\AIOFulfilmentWebJob'
              zipAfterPublish: false
              modifyOutputPath: false

          - task: DotNetCoreCLI@2
            displayName: "Publish BESS Configuration Service Code"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "**/*UKHO.BESS.ConfigurationService.csproj"
              arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\PeriodicOutputFulfilmentService\App_Data\jobs\continuous\BESSConfigurationServiceWebJob'
              zipAfterPublish: false
              modifyOutputPath: false

          - task: DotNetCoreCLI@2
            displayName: "Publish BESS Builder Service Code"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "**/*UKHO.BESS.BuilderService.csproj"
              arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\PeriodicOutputFulfilmentService\App_Data\jobs\continuous\BESSBuilderServiceWebJob'
              zipAfterPublish: false
              modifyOutputPath: false

          - task: ArchiveFiles@2
            displayName: "Zip POS fulfilment service"
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)\PeriodicOutputFulfilmentService\'
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: '$(Build.ArtifactStagingDirectory)\PeriodicOutputFulfilmentService\PeriodicOutputFulfilmentService.zip'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: "Publish PeriodicOutputFulfilmentService Artifact"
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)\PeriodicOutputFulfilmentService'
              ArtifactName: PeriodicOutputService

          - task: PowerShell@2
            displayName: "Generate event id runbook"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)\Utility\XmlToRtfTransformation.ps1'
              arguments: '-xmlFilePath $(Build.ArtifactStagingDirectory)\PeriodicOutputFulfilmentService\App_Data\jobs\triggered\POSFulfilmentWebJob\UKHO.PeriodicOutputService.Common.xml -xsltFilePath $(Build.SourcesDirectory)\Utility\EventIdXmlTransformation.xslt -outputFileName Runbook-EventId'
          
          - task: PublishBuildArtifacts@1
            displayName: "Publish event id runbook"
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)\Utility\Runbook-EventId.rtf'
              ArtifactName: Runbook

      - job: PublishTerraformArtifacts
        workspace:
          clean: all
        displayName: "Publish Terraform Artifacts"
        steps:

          - task: PublishBuildArtifacts@1
            displayName: "Publish Dev terraform Artifacts"
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)\DevDeployment'
              ArtifactName: devterraformartifact              

          - task: PublishBuildArtifacts@1
            displayName: "Publish QA and Live terraform Artifacts"
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)\QALiveDeployment'
              ArtifactName: qaliveterraformartifact
              
          - task: PublishBuildArtifacts@1
            displayName: "Publish vNext terraform Artifacts"
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)\vNextE2EDeployment'
              ArtifactName: vnexte2eterraformartifact

          - task: PublishBuildArtifacts@1
            displayName: "Publish vNext terraform Artifacts"
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)\vNextIATDeployment'
              ArtifactName: vnextiatterraformartifact

      - job: PublishFunctionalTests
        workspace:
          clean: all
        displayName: "Publish Functional Tests"
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: sdk
              useGlobalJson: true
              workingDirectory: '$(Build.SourcesDirectory)'

          - task: DotNetCoreCLI@2
            displayName: ".Net Core - NuGet restore"
            inputs:
              command: restore
              projects: |
                **/*.csproj
              feedsToUse: config
              noCache: true
              nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
              workingDirectory: '$(Build.SourcesDirectory)\UKHO.PeriodicOutputService'

          - task: DotNetCoreCLI@2
            displayName: "Publish POS functional test"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "**/*UKHO.PeriodicOutputService.API.FunctionalTests.csproj"
              arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\UKHO.PeriodicOutputService.API.FunctionalTests'
              zipAfterPublish: false

          - task: PublishBuildArtifacts@1
            displayName: "Publish POS Functional test Artifact"
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)\UKHO.PeriodicOutputService.API.FunctionalTests'
              ArtifactName: posfunctionaltests

          - task: DotNetCoreCLI@2
            displayName: "Publish BESS functional test"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "**/*UKHO.BESS.API.FunctionalTests.csproj"
              arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\UKHO.BESS.API.FunctionalTests'
              zipAfterPublish: false

          - task: PublishBuildArtifacts@1
            displayName: "Publish BESS Functional test Artifact"
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)\UKHO.BESS.API.FunctionalTests'
              ArtifactName: bessfunctionaltests
        
      - job: BuildAndPublishMockAPI
        workspace:
          clean: all
        displayName: "Build and Publish Mock API"
        steps:
          - task: PowerShell@2
            displayName: "Set assembly version numbers based on build ID"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)\Apply-AssemblyVersionAndDefaults.ps1'
              arguments: '-buildNumber "$(Build.BuildNumber)" -solutionDirectory "$(Build.SourcesDirectory)\UKHO.FmEssFssMock.API\" -UKHOAssemblyCompany "$env:UKHOAssemblyCompany" -UKHOAssemblyCopyright "$(UKHOAssemblyCopyright)" -UKHOAssemblyVersionPrefix "$env:UKHOAssemblyVersionPrefix" -UKHOAssemblyProduct "$(UKHOAssemblyProduct) Mock"'

          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: sdk
              useGlobalJson: true
              workingDirectory: '$(Build.SourcesDirectory)'

          - task: DotNetCoreCLI@2
            displayName: ".Net Core - NuGet restore"
            inputs:
              command: restore
              projects: |
                **/*.csproj
              feedsToUse: config
              noCache: true
              nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
              workingDirectory: '$(Build.SourcesDirectory)\UKHO.FmEssFssMock.API'

          - task: DotNetCoreCLI@2
            displayName: "dotnet build task"
            inputs:
              command: "build"
              projects: "**/*UKHO.FmEssFssMock.API.csproj"
              arguments: '--configuration $(BuildConfiguration) --output $(Build.BinariesDirectory)'
              workingDirectory: '$(Build.SourcesDirectory)\UKHO.FmEssFssMock.API'

          - task: DotNetCoreCLI@2
            displayName: "Publish MockWebAPI"
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: '**/*UKHO.FmEssFssMock.API.csproj'
              arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\MockWebAPI'
              zipAfterPublish: true
              modifyOutputPath: true

          - task: PublishBuildArtifacts@1
            displayName: "Publish WebAPI Artifact"
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)\MockWebAPI'
              ArtifactName: MockWebAPI 

  - stage: Devdeploy
    displayName: "Devdeploy (inc terraform, webapp deploy)"
    variables:
      - group: "ESS-Dev-Variables"
      - group: "ESS-Deployment-Variables-DEV"
      - group: "POS-Dev-Variables"
      - name: "ESSApiConfiguration.TenantId"
        value: $(TenantId)
      - name: "ESSApiConfiguration.AutoTestClientId"
        value: $(AutoTestClientId_Authed)
      - name: "ESSApiConfiguration.AutoTestClientSecret"
        value: $(AutoTestClientSecret_Authed)
      - name: "ESSApiConfiguration.EssClientId"
        value: $(ESSClientId)
      - name: "ElasticAPM_ServerURL"
        value: $(ElasticAPM.ServerURL)
      - name: "ElasticAPM_ApiKey"
        value: $(ElasticAPM.ApiKey)

    jobs:
      - deployment: DevDeployApp
        displayName: "Dev - Deploy Terraform and Dotnet App"
        environment: "Ess-Dev"
        pool: $(DeploymentPool)
        container: ${{variables.Container}}
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: DevDeployment/templates/continuous-deployment.yml
                  parameters:
                    ContinueEvenIfResourcesAreGettingDestroyed: ${{ parameters.ContinueEvenIfResourcesAreGettingDestroyed }}
                    AzureSubscription: "Exchange-Set-Service-Dev-A-008-02"

      - job: CheckInfra
        displayName: "Check Infrastructure Health"
        dependsOn: DevDeployApp
        variables:
          - name: WEB_APP_NAME
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.WEBAPP']  ]
          - name: RGName
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.ResourceGroup']  ]
        steps:
          - task: AzureCLI@2
            displayName: "Check Infrastructure is healthy"
            inputs:
              azureSubscription: "Exchange-Set-Service-Dev-A-008-02"
              scriptType: 'pscore'
              scriptLocation: 'scriptPath'
              scriptPath: '$(Build.SourcesDirectory)/DevDeployment/check_service_status_webjob.ps1'
              arguments: '-RGName $(RGName) -webAppName $(WEB_APP_NAME) -waitTimeInMinute $(waitTimeInMinute)'

      - job: CheckFSS
        displayName: "Check FSS Health"
        dependsOn: DevDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check FSS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: "$(Build.SourcesDirectory)/DevDeployment/check_health_endpoint.ps1"
              arguments: "-healthEndPointUrl $(FSSHealthEndpoint)/heartbeat -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckESS
        displayName: "Check ESS Health"
        dependsOn: DevDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check ESS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/DevDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(ESSHealthEndpoint)/health -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckFM
        displayName: "Check Fleet Manager Health"
        dependsOn: DevDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check FM Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/DevDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(FMHealthEndpoint)/health-check -waitTimeInMinute $(waitTimeInMinute)"

      - job: SetPOSQASubnet
        displayName: "Set QA Subnet Configuration"
        dependsOn: DevDeployApp
        pool: $(DeploymentPool)
        container: ${{variables.Container}}
        variables:
          - name: mockWebAppName
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.mockWebApp']  ]
          - name: mockWebAppResourceGroup
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.mockWebAppResourceGroupName']  ]
        steps:
          - task: AzureCLI@2
            displayName: "Set QA Subnet Configuration"
            inputs:
              azureSubscription: "Exchange-Set-Service-Dev-A-008-02"
              scriptType: 'pscore'
              scriptLocation: 'scriptPath'
              scriptPath: '$(Build.SourcesDirectory)/DevDeployment/set_qa_subnet_configuration.ps1'
              arguments: '-mockresourcegroup $(mockWebAppResourceGroup) -mockwebappname $(mockWebAppName) -qasubscriptionid $(POSESSQASubscriptionId) -qavnetresourcegroup $(spokeRG) -qavnetname $(POSESSQAspokeVnetName) -qasubnetname $(POSESSspokeSubnetName)'
                         
      - job: POSFunctionalTests
        dependsOn:
         - DevDeployApp
         - CheckInfra
         - CheckFSS
         - CheckESS
         - CheckFM
        pool: NautilusBuild
        displayName: "Dev POS Functional Automated Tests"
        workspace:
          clean: all
        variables:
          - name: POSWebjobApiConfiguration.UserName
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.webJobUsername']  ]
          - name: POSWebjobApiConfiguration.Password
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.webJobPassword']  ]
        steps:
          - task: DownloadBuildArtifacts@0
            displayName: "Download POS Functional test Artifact"
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'posfunctionaltests'
              downloadPath: '$(Build.SourcesDirectory)'

          - task: FileTransform@2
            displayName: "File Transform: functionaltests"
            inputs:
              folderPath: '$(Build.SourcesDirectory)/posfunctionaltests/'
              xmlTransformationRules:
              jsonTargetFiles: '**/appsettings.json'

          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: sdk
              version: 6.0.x

          - task: DotNetCoreCLI@2
            displayName: "Run POS Functional tests"
            inputs:
              command: "test"
              projects: |
                       **/*FunctionalTest*.dll
                       !**/*TestAdapter.dll
                       !**/obj/**
              arguments: '--filter Category~CallEssEndPoint|Category~GetAVCSCatalogue|Category~POSEndToEndScenarioFullAvcsPollingTimeOut|Category~POSEndToEndScenarioUpdatePollingTimeOut|Category~POSEndToEndScenarioWithInvalidProductIdentifier|Category~POSEndToEndValidFunctionalScenarios|Category~POSAIOValidFunctionalScenarios|Category~POSAIOScenarioWithInvalidProductIdentifier|Category~POSAIOScenarioPollingTimeOut'
              testRunTitle: "Dev-POSAutomationTests"
              workingDirectory: '$(Build.SourcesDirectory)/posfunctionaltests'

      - job: BESSFunctionalTests
        dependsOn:
        - DevDeployApp
        - CheckInfra
        - CheckFSS
        - CheckESS
        - CheckFM
        - POSFunctionalTests 
        pool: NautilusBuild
        displayName: "Dev BESS Functional Automated Tests"
        workspace:
         clean: all
        variables:
          - name: AzureWebJobsStorage
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.AzureWebJobsStorageName']  ]
          - name: WEB_APP_NAME
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.WEBAPP']  ]
          - name: mockWebAppName
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.mockWebApp']  ]
          - name: mockWebAppResourceGroup
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.mockWebAppResourceGroupName']  ]
          - name: RGName
            value: $[ dependencies.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.ResourceGroup']  ]
        steps:
                - task: DownloadBuildArtifacts@0
                  displayName: "Download BESS Functional test Artifact"
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'bessfunctionaltests'
                    downloadPath: '$(Build.SourcesDirectory)'

                - task: FileTransform@2
                  displayName: "File Transform: functionaltests"
                  inputs:
                    folderPath: '$(Build.SourcesDirectory)/bessfunctionaltests/'
                    xmlTransformationRules:
                    jsonTargetFiles: '**/appsettings.json'

                - task: UseDotNet@2
                  displayName: 'Use .NET SDK'
                  inputs:
                    packageType: sdk
                    version: 6.0.x

                - task: DotNetCoreCLI@2
                  displayName: "Run BESS Functional tests"
                  inputs:
                    command: "test"
                    projects: |
                      **/*FunctionalTest*.dll
                      !**/*TestAdapter.dll
                      !**/obj/**
                    testRunTitle: "Dev-BESSAutomationTests"
                    workingDirectory: '$(Build.SourcesDirectory)/bessfunctionaltests'

                - task: DownloadBuildArtifacts@0
                  displayName: "Download Terraform Artifact"
                  condition: always()
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'devterraformartifact'
                    downloadPath: '$(Build.SourcesDirectory)'

                - task: AzureCLI@2
                  displayName: "Swap Stub and Webjob Configuration"
                  condition: always()
                  inputs:
                    azureSubscription: "Exchange-Set-Service-Dev-A-008-02"
                    scriptType: 'pscore'
                    scriptLocation: 'scriptPath'
                    scriptPath: "$(Build.SourcesDirectory)/devterraformartifact/set_stub_webjob_configuration.ps1"
                    arguments: '-essapibaseurl $(ESSApiConfiguration.BaseUrl_PostFT) -fssapibaseurl $(FSSApiConfiguration.BaseUrl_PostFT) -fleetmanagerbaseurl $(FleetManagerB2BApiConfiguration.BaseUrl_PostFT) -fleetmanagerfilepath $(FleetManagerB2BApiConfiguration.GetCatalogueResponseFilePath_PostFT) -ftrunning "false" -fssapipollingcutoffime $(FSSApiConfiguration.BatchStatusPollingCutoffTime_PostFT) -fssapipollingdelaytime $(FSSApiConfiguration.BatchStatusPollingDelayTime_PostFT) -resourcegroup $(RGName) -webappname $(WEB_APP_NAME) -mockresourcegroup $(mockWebAppResourceGroup) -mockwebappname $(mockWebAppName)'

  - stage: QAdeploy
    dependsOn: Devdeploy
    displayName: "QAdeploy (inc terraform, webapp deploy)"
    variables:
      - group: "ESS-QA-Variables"
      - group: "ESS-Deployment-Variables-QA"
      - group: "POS-QA-Variables"
      - name: "ESSApiConfiguration.TenantId"
        value: $(TenantId)
      - name: "ESSApiConfiguration.AutoTestClientId"
        value: $(AutoTestClientId_Authed)
      - name: "ESSApiConfiguration.AutoTestClientSecret"
        value: $(AutoTestClientSecret_Authed)
      - name: "ESSApiConfiguration.EssClientId"
        value: $(ESSClientId)
      - name: "ElasticAPM_ServerURL"
        value: $(ElasticAPM.ServerURL)
      - name: "ElasticAPM_ApiKey"
        value: $(ElasticAPM.ApiKey)
    condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'),startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')))

    jobs:
      - deployment: QADeployApp
        displayName: "QA - Deploy Terraform and Dotnet App"
        environment: "Ess-Qa"
        pool: $(DeploymentPool)
        container: ${{variables.Container}}
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: QALiveDeployment/templates/continuous-deployment.yml
                  parameters:
                    ContinueEvenIfResourcesAreGettingDestroyed: ${{ parameters.ContinueEvenIfResourcesAreGettingDestroyed }}
                    AzureSubscription: "Exchange-Set-Service-QA-A-008-02"

      - job: CheckInfra
        displayName: "Check Infrastructure Health"
        dependsOn: QADeployApp
        variables:
          - name: WEB_APP_NAME
            value: $[ dependencies.QADeployApp.outputs['QADeployApp.TerraformDeploy.WEBAPP']  ]
          - name: RGName
            value: $[ dependencies.QADeployApp.outputs['QADeployApp.TerraformDeploy.ResourceGroup']  ]
        steps:
          - task: AzureCLI@2
            displayName: "Check Infrastructure is healthy"
            inputs:
              azureSubscription: "Exchange-Set-Service-QA-A-008-02"
              scriptType: 'pscore'
              scriptLocation: 'scriptPath'
              scriptPath: '$(Build.SourcesDirectory)/QALiveDeployment/check_service_status_webjob.ps1'
              arguments: '-RGName $(RGName) -webAppName $(WEB_APP_NAME) -waitTimeInMinute $(waitTimeInMinute)'

      - job: CheckFSS
        displayName: "Check FSS Health"
        dependsOn: QADeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check FSS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: "$(Build.SourcesDirectory)/QALiveDeployment/check_health_endpoint.ps1"
              arguments: "-healthEndPointUrl $(FSSHealthEndpoint)/heartbeat -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckESS
        displayName: "Check ESS Health"
        dependsOn: QADeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check ESS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/QALiveDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(ESSHealthEndpoint)/health -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckFM
        displayName: "Check Fleet Manager Health"
        dependsOn: QADeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check FM Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/QALiveDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(FMHealthEndpoint)/health-check -waitTimeInMinute $(waitTimeInMinute)"

      - job: POSFunctionalTests
        dependsOn:
        - QADeployApp
        - CheckInfra
        - CheckFSS
        - CheckESS
        - CheckFM
        pool: NautilusBuild
        displayName: "QA POS Functional Automated Tests"
        workspace:
         clean: all
        variables:
          - name: mockWebAppName
            value: $[ stageDependencies.Devdeploy.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.mockWebApp']  ]
          - name: mockWebAppResourceGroup
            value: $[ stageDependencies.Devdeploy.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.mockWebAppResourceGroupName']  ]
          - name: POSWebjobApiConfiguration.UserName
            value: $[ dependencies.QADeployApp.outputs['QADeployApp.TerraformDeploy.webJobUsername']  ]
          - name: POSWebjobApiConfiguration.Password
            value: $[ dependencies.QADeployApp.outputs['QADeployApp.TerraformDeploy.webJobPassword']  ]
        steps:

                - task: AzureCLI@2
                  displayName: "Swap Stub Configuration"
                  condition: always()
                  inputs:
                    azureSubscription: "Exchange-Set-Service-Dev-A-008-02"
                    scriptType: 'pscore'
                    scriptLocation: 'scriptPath'
                    scriptPath: "$(Build.SourcesDirectory)/QALiveDeployment/set_stub_configuration.ps1"
                    arguments: '-fleetmanagerfilepath $(FleetManagerB2BApiConfiguration.GetCatalogueResponseFilePath) -ftrunning "true" -mockresourcegroup $(mockWebAppResourceGroup) -mockwebappname $(mockWebAppName)'

                - task: DownloadBuildArtifacts@0
                  displayName: "Download POS Functional test Artifact"
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'posfunctionaltests'
                    downloadPath: '$(Build.SourcesDirectory)'

                - task: FileTransform@2
                  displayName: "File Transform: functionaltests"
                  inputs:
                    folderPath: '$(Build.SourcesDirectory)/posfunctionaltests/'
                    xmlTransformationRules:
                    jsonTargetFiles: '**/appsettings.json'

                - task: UseDotNet@2
                  displayName: 'Use .NET SDK'
                  inputs:
                    packageType: sdk
                    version: 6.0.x

                - task: DotNetCoreCLI@2
                  displayName: "Run POS Functional tests"
                  inputs:
                    command: "test"
                    projects: |
                      **/*FunctionalTest*.dll
                      !**/*TestAdapter.dll
                      !**/obj/**
                    arguments: '--filter Category~CallEssEndPoint|Category~GetAVCSCatalogue|Category~POSEndToEndScenarioFullAvcsPollingTimeOut|Category~POSEndToEndScenarioUpdatePollingTimeOut|Category~POSEndToEndScenarioWithInvalidProductIdentifier|Category~POSEndToEndValidFunctionalScenarios|Category~POSAIOValidFunctionalScenarios|Category~POSAIOScenarioWithInvalidProductIdentifier|Category~POSAIOScenarioPollingTimeOut'
                    testRunTitle: "QA-POSAutomationTests"
                    workingDirectory: '$(Build.SourcesDirectory)/posfunctionaltests'

      - job: BESSFunctionalTests
        dependsOn:
        - QADeployApp
        - CheckInfra
        - CheckFSS
        - CheckESS
        - CheckFM
        - POSFunctionalTests
        pool: NautilusBuild
        displayName: "QA BESS Functional Automated Tests"
        workspace:
         clean: all
        variables:
          - name: AzureWebJobsStorage
            value: $[ dependencies.QADeployApp.outputs['QADeployApp.TerraformDeploy.AzureWebJobsStorageName']  ]
          - name: WEB_APP_NAME
            value: $[ dependencies.QADeployApp.outputs['QADeployApp.TerraformDeploy.WEBAPP']  ]
          - name: mockWebAppName
            value: $[ stageDependencies.Devdeploy.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.mockWebApp']  ]
          - name: mockWebAppResourceGroup
            value: $[ stageDependencies.Devdeploy.DevDeployApp.outputs['DevDeployApp.TerraformDeploy.mockWebAppResourceGroupName']  ]
          - name: RGName
            value: $[ dependencies.QADeployApp.outputs['QADeployApp.TerraformDeploy.ResourceGroup']  ]
        steps:
                - task: DownloadBuildArtifacts@0
                  displayName: "Download BESS Functional test Artifact"
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'bessfunctionaltests'
                    downloadPath: '$(Build.SourcesDirectory)'

                - task: FileTransform@2
                  displayName: "File Transform: functionaltests"
                  inputs:
                    folderPath: '$(Build.SourcesDirectory)/bessfunctionaltests/'
                    xmlTransformationRules:
                    jsonTargetFiles: '**/appsettings.json'

                - task: UseDotNet@2
                  displayName: 'Use .NET SDK'
                  inputs:
                    packageType: sdk
                    version: 6.0.x

                - task: DotNetCoreCLI@2
                  displayName: "Run BESS Functional tests"
                  inputs:
                    command: "test"
                    projects: |
                      **/*FunctionalTest*.dll
                      !**/*TestAdapter.dll
                      !**/obj/**
                    testRunTitle: "QA-BESSAutomationTests"
                    workingDirectory: '$(Build.SourcesDirectory)/bessfunctionaltests'

                - task: DownloadBuildArtifacts@0
                  displayName: "Download Terraform Artifact"
                  condition: always()
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'qaliveterraformartifact'
                    downloadPath: '$(Build.SourcesDirectory)'

                - task: AzureCLI@2
                  displayName: "Swap Webjob Configuration"
                  condition: always()
                  inputs:
                    azureSubscription: "Exchange-Set-Service-QA-A-008-02"
                    scriptType: 'pscore'
                    scriptLocation: 'scriptPath'
                    scriptPath: "$(Build.SourcesDirectory)/qaliveterraformartifact/set_webjob_configuration.ps1"
                    arguments: '-essapibaseurl $(ESSApiConfiguration.BaseUrl_PostFT) -fssapibaseurl $(FSSApiConfiguration.BaseUrl_PostFT) -fleetmanagerbaseurl $(FleetManagerB2BApiConfiguration.BaseUrl_PostFT) -ftrunning "false" -fssapipollingcutoffime $(FSSApiConfiguration.BatchStatusPollingCutoffTime_PostFT) -fssapipollingdelaytime $(FSSApiConfiguration.BatchStatusPollingDelayTime_PostFT) -resourcegroup $(RGName) -webappname $(WEB_APP_NAME)'

                - task: AzureCLI@2
                  displayName: "Swap Stub Configuration"
                  condition: always()
                  inputs:
                    azureSubscription: "Exchange-Set-Service-Dev-A-008-02"
                    scriptType: 'pscore'
                    scriptLocation: 'scriptPath'
                    scriptPath: "$(Build.SourcesDirectory)/qaliveterraformartifact/set_stub_configuration.ps1"
                    arguments: '-fleetmanagerfilepath $(FleetManagerB2BApiConfiguration.GetCatalogueResponseFilePath_PostFT) -ftrunning "false" -mockresourcegroup $(mockWebAppResourceGroup) -mockwebappname $(mockWebAppName)'

  - stage: Livedeploy
    displayName: "Livedeploy (inc terraform, webapp deploy)"
    variables:
      - group: "ESS-Live-Variables"
      - group: "ESS-Deployment-Variables-LIVE"
      - group: "POS-Live-Variables"
      - name: "ElasticAPM_ServerURL"
        value: $(ElasticAPM.ServerURL)
      - name: "ElasticAPM_ApiKey"
        value: $(ElasticAPM.ApiKey)
    condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'),startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')))
    jobs:
      - deployment: LiveDeployApp
        displayName: "Live - Deploy Terraform and Dotnet App"
        environment: "Ess-Live"
        pool: $(DeploymentPool)
        container: ${{variables.Container}}
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: QALiveDeployment/templates/continuous-deployment.yml
                  parameters:
                    ContinueEvenIfResourcesAreGettingDestroyed: ${{ parameters.ContinueEvenIfResourcesAreGettingDestroyed }}
                    AzureSubscription: "Exchange-Set-Service-Live-A-008-02"

      - job: LiveSetup
        displayName: "Set Webjob Configuration For Live"
        dependsOn: LiveDeployApp
        variables:
          - name: WEB_APP_NAME
            value: $[ dependencies.LiveDeployApp.outputs['LiveDeployApp.TerraformDeploy.WEBAPP']  ]
          - name: RGName
            value: $[ dependencies.LiveDeployApp.outputs['LiveDeployApp.TerraformDeploy.ResourceGroup']  ]
        steps:
          - task: AzureCLI@2
            displayName: "Swap Webjob Configuration"
            condition: always()
            inputs:
              azureSubscription: "Exchange-Set-Service-Live-A-008-02"
              scriptType: 'pscore'
              scriptLocation: 'scriptPath'
              scriptPath: "$(Build.SourcesDirectory)/QALiveDeployment/set_webjob_configuration.ps1"
              arguments: '-essapibaseurl $(ESSApiConfiguration.BaseUrl) -fssapibaseurl $(FSSApiConfiguration.BaseUrl) -fleetmanagerbaseurl $(FleetManagerB2BApiConfiguration.BaseUrl) -ftrunning "false" -fssapipollingcutoffime $(FSSApiConfiguration.BatchStatusPollingCutoffTime) -fssapipollingdelaytime $(FSSApiConfiguration.BatchStatusPollingDelayTime) -resourcegroup $(RGName) -webappname $(WEB_APP_NAME)'

      - job: CheckInfra
        displayName: "Check Infrastructure Health"
        dependsOn:
        -  LiveDeployApp
        -  LiveSetup
        variables:
          - name: WEB_APP_NAME
            value: $[ dependencies.LiveDeployApp.outputs['LiveDeployApp.TerraformDeploy.WEBAPP']  ]
          - name: RGName
            value: $[ dependencies.LiveDeployApp.outputs['LiveDeployApp.TerraformDeploy.ResourceGroup']  ]
        steps:
          - task: AzureCLI@2
            displayName: "Check Infrastructure is healthy"
            inputs:
              azureSubscription: "Exchange-Set-Service-Live-A-008-02"
              scriptType: 'pscore'
              scriptLocation: 'scriptPath'
              scriptPath: '$(Build.SourcesDirectory)/QALiveDeployment/check_service_status_webjob.ps1'
              arguments: '-RGName $(RGName) -webAppName $(WEB_APP_NAME) -waitTimeInMinute $(waitTimeInMinute)'

      - job: CheckFSS
        displayName: "Check FSS Health"
        dependsOn:
        -  LiveDeployApp
        -  LiveSetup
        steps:
          - task: PowerShell@2
            displayName: "Check FSS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: "$(Build.SourcesDirectory)/QALiveDeployment/check_health_endpoint.ps1"
              arguments: "-healthEndPointUrl $(FSSHealthEndpoint)/heartbeat -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckESS
        displayName: "Check ESS Health"
        dependsOn:
        -  LiveDeployApp
        -  LiveSetup
        steps:
          - task: PowerShell@2
            displayName: "Check ESS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/QALiveDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(ESSHealthEndpoint)/health -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckFM
        displayName: "Check Fleet Manager Health"
        dependsOn:
        -  LiveDeployApp
        -  LiveSetup
        steps:
          - task: PowerShell@2
            displayName: "Check FM Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/QALiveDeployment/check_health_endpoint_fm_live.ps1'
              arguments: "-healthEndPointUrl $(FMHealthEndpoint)/live/echo/health-check -waitTimeInMinute $(waitTimeInMinute) -ocpapimsubscriptionkey $(FM_Ocp_Apim_Subscription_Key)"

      - job: PostDeploymentActions
        dependsOn:
        - LiveDeployApp
        - LiveSetup
        - CheckInfra
        - CheckFSS
        - CheckESS
        - CheckFM        
        pool: $(WindowPool)        
        displayName: Post Deployment Actions
        steps:
          - template: QALiveDeployment/templates/retain-pipeline.yml

  - stage: vNextIATDeploy
    dependsOn: 
      - Devdeploy
    displayName: vNext IAT Deploy (inc terraform, webapp deploy)
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/main'), not(startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')))
    variables:
      - group: "ESS-vNextIAT-Variables"
      - group: "ESS-Deployment-Variables-vNextIAT"
      - group: "POS-vNextIAT-Variables"
      - name: "ESSApiConfiguration.TenantId"
        value: $(TenantId)
      - name: "ESSApiConfiguration.AutoTestClientId"
        value: $(AutoTestClientId_Authed)
      - name: "ESSApiConfiguration.AutoTestClientSecret"
        value: $(AutoTestClientSecret_Authed)
      - name: "ESSApiConfiguration.EssClientId"
        value: $(ESSClientId)
      - name: "ElasticAPM_ServerURL"
        value: $(ElasticAPM.ServerURL)
      - name: "ElasticAPM_ApiKey"
        value: $(ElasticAPM.ApiKey)
    jobs:
      - deployment: vNextIATDeployApp
        displayName: "vNextIAT - Deploy Terraform and Dotnet App"
        environment: "Ess-vnextiat"
        pool: $(DeploymentPool)
        container: ${{variables.Container}}
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: vNextIATDeployment/templates/continuous-deployment.yml
                  parameters:
                    ContinueEvenIfResourcesAreGettingDestroyed: ${{ parameters.ContinueEvenIfResourcesAreGettingDestroyed }}
                    AzureSubscription: "Exchange-Set-Service-vNext-IAT-A.011.08"

      - job: CheckInfra
        displayName: "Check Infrastructure Health"
        dependsOn: vNextIATDeployApp
        variables:
          - name: WEB_APP_NAME
            value: $[ dependencies.vNextIATDeployApp.outputs['vNextIATDeployApp.TerraformDeploy.WEBAPP']  ]
          - name: RGName
            value: $[ dependencies.vNextIATDeployApp.outputs['vNextIATDeployApp.TerraformDeploy.ResourceGroup']  ]
        steps:
          - task: AzureCLI@2
            displayName: "Check Infrastructure is healthy"
            inputs:
              azureSubscription: "Exchange-Set-Service-vNext-IAT-A.011.08"
              scriptType: 'pscore'
              scriptLocation: 'scriptPath'
              scriptPath: '$(Build.SourcesDirectory)/vNextIATDeployment/check_service_status_webjob.ps1'
              arguments: '-RGName $(RGName) -webAppName $(WEB_APP_NAME) -waitTimeInMinute $(waitTimeInMinute)'

      - job: CheckFSS
        displayName: "Check FSS Health"
        dependsOn: vNextIATDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check FSS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: "$(Build.SourcesDirectory)/vNextIATDeployment/check_health_endpoint.ps1"
              arguments: "-healthEndPointUrl $(FSSHealthEndpoint)/heartbeat -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckESS
        displayName: "Check ESS Health"
        dependsOn: vNextIATDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check ESS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/vNextIATDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(ESSHealthEndpoint)/health -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckFM
        displayName: "Check Fleet Manager Health"
        dependsOn: vNextIATDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check FM Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/vNextIATDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(FMHealthEndpoint)/health-check -waitTimeInMinute $(waitTimeInMinute)"

  - stage: vnexte2eDeploy
    dependsOn: 
       - vNextIATDeploy
    displayName: vNext E2E Deploy (inc terraform, webapp deploy)
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/main'), not(startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')))
    variables:
      - group: "ESS-vNextE2E-Variables"
      - group: "ESS-Deployment-Variables-vNextE2E"
      - group: "POS-vNextE2E-Variables"
      - name: "ESSApiConfiguration.TenantId"
        value: $(TenantId)
      - name: "ESSApiConfiguration.AutoTestClientId"
        value: $(AutoTestClientId_Authed)
      - name: "ESSApiConfiguration.AutoTestClientSecret"
        value: $(AutoTestClientSecret_Authed)
      - name: "ESSApiConfiguration.EssClientId"
        value: $(ESSClientId)
      - name: "ElasticAPM_ServerURL"
        value: $(ElasticAPM.ServerURL)
      - name: "ElasticAPM_ApiKey"
        value: $(ElasticAPM.ApiKey)
    jobs:
      - deployment: vNextE2EDeployApp
        displayName: "vNextE2E - Deploy Terraform and Dotnet App"
        environment: "Ess-vnexte2e"
        pool: $(DeploymentPool)
        container: ${{variables.Container}}
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: vNextE2EDeployment/templates/continuous-deployment.yml
                  parameters:
                    ContinueEvenIfResourcesAreGettingDestroyed: ${{ parameters.ContinueEvenIfResourcesAreGettingDestroyed }}
                    AzureSubscription: "Exchange-Set-Service-vNext-E2E-A.011.08"

      - job: CheckInfra
        displayName: "Check Infrastructure Health"
        dependsOn: vNextE2EDeployApp
        variables:
          - name: WEB_APP_NAME
            value: $[ dependencies.vNextE2EDeployApp.outputs['vNextE2EDeployApp.TerraformDeploy.WEBAPP']  ]
          - name: RGName
            value: $[ dependencies.vNextE2EDeployApp.outputs['vNextE2EDeployApp.TerraformDeploy.ResourceGroup']  ]
        steps:
          - task: AzureCLI@2
            displayName: "Check Infrastructure is healthy"
            inputs:
              azureSubscription: "Exchange-Set-Service-vNext-E2E-A.011.08"
              scriptType: 'pscore'
              scriptLocation: 'scriptPath'
              scriptPath: '$(Build.SourcesDirectory)/vNextE2EDeployment/check_service_status_webjob.ps1'
              arguments: '-RGName $(RGName) -webAppName $(WEB_APP_NAME) -waitTimeInMinute $(waitTimeInMinute)'

      - job: CheckFSS
        displayName: "Check FSS Health"
        dependsOn: vNextE2EDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check FSS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: "$(Build.SourcesDirectory)/vNextE2EDeployment/check_health_endpoint.ps1"
              arguments: "-healthEndPointUrl $(FSSHealthEndpoint)/heartbeat -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckESS
        displayName: "Check ESS Health"
        dependsOn: vNextE2EDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check ESS Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/vNextE2EDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(ESSHealthEndpoint)/health -waitTimeInMinute $(waitTimeInMinute)"

      - job: CheckFM
        displayName: "Check Fleet Manager Health"
        dependsOn: vNextE2EDeployApp
        steps:
          - task: PowerShell@2
            displayName: "Check FM Health endpoint is healthy"
            inputs:
              targetType: filePath
              filePath: '$(Build.SourcesDirectory)/vNextE2EDeployment/check_health_endpoint.ps1'
              arguments: "-healthEndPointUrl $(FMHealthEndpoint)/health-check -waitTimeInMinute $(waitTimeInMinute)"
